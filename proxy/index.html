<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="css/maplibre-gl-3.6.css">
  <style>
      html,
      body {
          padding: 0;
          margin: 0;
      }

      #map {
          width: 100vw;
          height: 100vh;
      }
  </style>
  <title>MapLibre demo</title>
</head>

<body>
<div id="map"></div>

<script src="js/maplibre-gl-3.6.js"></script>
<script>
  let center = [6.8788, 52.2309];
  let zoom = 14;
  try {
    const localZoom = localStorage.getItem('zoom')
    if (localZoom) {
      zoom = parseFloat(localZoom);
    }
  } catch (e) {
    console.error('Error while parsing local storage zoom level', e)
  }
  try {
    const localCenter = localStorage.getItem('center')
    if (localCenter) {
      center = JSON.parse(localCenter);
    }
  } catch (e) {
    console.error('Error while parsing local storage center', e)
  }


  const railwayLineWidth = ['step', ['zoom'],
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
      ], 1.5,
      0,
    ],
    6,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
      ], 2.5,
      0,
    ],
    8,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['any',
          ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'branch'], ['==', ['get', 'service'], null]],
        ]
      ], 1.5,
      0,
    ],
    9,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['any',
          ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'branch'], ['==', ['get', 'service'], null]],
        ]
      ], 3.5,
      ['all',
        ['==', ['get', 'railway'], 'construction'],
        ['==', ['get', 'construction_railway'], 'rail'],
        ['any', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'usage'], 'branch']],
        ['==', ['get', 'service'], null],
      ],
      ['case',
        ['!=', ['get', 'service'], null], 1.5,
        3,
      ],
      0,
    ],
    10,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['any',
          ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'branch'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]],
        ]
      ],
      ['case',
        ['all', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]], 2,
        3.5,
      ],
      ['all',
        ['==', ['get', 'railway'], 'narrow_gauge'],
        ['==', ['get', 'service'], null],
      ],
      ['case',
        ['any', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]], 2,
        3,
      ],
      ['any',
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['==', ['get', 'construction_railway'], 'rail'],
          ['any', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'usage'], 'branch']],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['any',
            ['==', ['get', 'construction_railway'], 'subway'],
            ['==', ['get', 'construction_railway'], 'light_rail'],
          ],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['any',
            ['==', ['get', 'railway'], 'subway'],
            ['==', ['get', 'railway'], 'light_rail'],
          ],
          ['==', ['get', 'service'], null],
        ],
      ],
      ['case',
        ['!=', ['get', 'service'], null], 1.5,
        3,
      ],
      0,
    ],
    11,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['any',
          ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'branch'], ['==', ['get', 'service'], null]],
          ['==', ['get', 'usage'], 'industrial'],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'siding']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'crossover']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'spur']],
        ]
      ],
      ['case',
        ['any',
          ['all', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'siding']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'crossover']],
        ], 2,
        ['any',
          ['all', ['==', ['get', 'usage'], 'industrial'], ['!=', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'spur']],
        ], 1.5,
        3.5,
      ],
      ['all',
        ['==', ['get', 'railway'], 'narrow_gauge'],
        ['any',
          ['==', ['get', 'service'], null],
          ['==', ['get', 'service'], 'spur'],
          ['==', ['get', 'service'], 'siding'],
          ['==', ['get', 'service'], 'crossover'],
        ],
      ],
      ['case',
        ['any', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]], 2,
        3,
      ],
      ['any',
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['==', ['get', 'construction_railway'], 'rail'],
          ['any', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'usage'], 'branch']],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['any',
            ['==', ['get', 'construction_railway'], 'subway'],
            ['==', ['get', 'construction_railway'], 'light_rail'],
            ['==', ['get', 'construction_railway'], 'tram'],
          ],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['any',
            ['==', ['get', 'railway'], 'subway'],
            ['==', ['get', 'railway'], 'light_rail'],
            ['==', ['get', 'railway'], 'tram'],
          ],
          ['==', ['get', 'service'], null],
        ],
      ],
      ['case',
        ['!=', ['get', 'service'], null], 1.5,
        3,
      ],
      0,
    ],
    12,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['any',
          ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'branch'], ['==', ['get', 'service'], null]],
          ['==', ['get', 'usage'], 'industrial'],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'siding']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'crossover']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'spur']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'yard']],
        ]
      ],
      ['case',
        ['any',
          ['all', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'siding']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'crossover']],
        ], 2,
        ['any',
          ['all', ['==', ['get', 'usage'], 'industrial'], ['!=', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'spur']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'yard']],
        ], 1.5,
        3.5,
      ],
      ['all',
        ['==', ['get', 'railway'], 'narrow_gauge'],
        ['any',
          ['==', ['get', 'service'], null],
          ['==', ['get', 'service'], 'spur'],
          ['==', ['get', 'service'], 'siding'],
          ['==', ['get', 'service'], 'crossover'],
          ['==', ['get', 'service'], 'yard'],
        ],
      ],
      ['case',
        ['any', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]], 2,
        3,
      ],
      ['any',
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['==', ['get', 'construction_railway'], 'rail'],
          ['any', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'usage'], 'branch']],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['any',
            ['==', ['get', 'construction_railway'], 'subway'],
            ['==', ['get', 'construction_railway'], 'light_rail'],
            ['==', ['get', 'construction_railway'], 'tram'],
          ],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['any',
            ['==', ['get', 'railway'], 'subway'],
            ['==', ['get', 'railway'], 'light_rail'],
            ['==', ['get', 'railway'], 'tram'],
          ],
          ['==', ['get', 'service'], null],
        ],
      ],
      ['case',
        ['!=', ['get', 'service'], null], 1.5,
        3,
      ],
      0,
    ],
    13,
    ['case',
      ['all',
        ['==', ['get', 'railway'], 'rail'],
        ['any',
          ['all', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], 'branch'], ['==', ['get', 'service'], null]],
          ['==', ['get', 'usage'], 'industrial'],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'siding']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'crossover']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'spur']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'yard']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], null]],
        ]
      ],
      ['case',
        ['any',
          ['all', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'siding']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'crossover']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], null]],
        ], 2,
        ['any',
          ['all', ['==', ['get', 'usage'], 'industrial'], ['!=', ['get', 'service'], null]],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'spur']],
          ['all', ['==', ['get', 'usage'], null], ['==', ['get', 'service'], 'yard']],
        ], 1.5,
        3.5,
      ],
      ['all',
        ['==', ['get', 'railway'], 'narrow_gauge'],
        ['any',
          ['==', ['get', 'service'], null],
          ['==', ['get', 'service'], 'spur'],
          ['==', ['get', 'service'], 'siding'],
          ['==', ['get', 'service'], 'crossover'],
          ['==', ['get', 'service'], 'yard'],
        ],
      ],
      ['case',
        ['any', ['==', ['get', 'usage'], 'industrial'], ['==', ['get', 'service'], null]], 2,
        3,
      ],
      ['any',
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['==', ['get', 'construction_railway'], 'rail'],
          ['any', ['==', ['get', 'usage'], 'main'], ['==', ['get', 'usage'], 'branch']],
          ['==', ['get', 'service'], null],
        ],
        ['all',
          ['==', ['get', 'railway'], 'construction'],
          ['any',
            ['==', ['get', 'construction_railway'], 'subway'],
            ['==', ['get', 'construction_railway'], 'light_rail'],
            ['==', ['get', 'construction_railway'], 'tram'],
            ['==', ['get', 'construction_railway'], 'narrow_gauge'],
          ],
          ['==', ['get', 'service'], null],
        ],
        ['any',
          ['==', ['get', 'railway'], 'subway'],
          ['==', ['get', 'railway'], 'light_rail'],
          ['==', ['get', 'railway'], 'tram'],
        ],
      ],
      ['case',
        ['!=', ['get', 'service'], null], 1.5,
        3,
      ],
      0,
    ],
  ];
  const casingPaint = dashArray => ({
    'line-color': 'white',
    'line-width': railwayLineWidth,
    'line-gap-width': 2,
    'line-dasharray': dashArray,
  });
  const casingLayout = {
    'line-join': 'round',
  };
  const fillPaint = dashArray => ({
    'line-color': ['case',
      ['==', ['get', 'zsi127'], 'yes'], '#884400',
      ['!=', ['get', 'ptc'], 'no'], '#cc0033',
      ['!=', ['get', 'construction_etcs'], 'no'], '#87CEFA',
      ['!=', ['get', 'etcs'], 'no'], 'blue',
      ['any',
        ['==', ['get', 'tvm'], 'yes'],
        ['==', ['get', 'tvm'], '430'],
        ['==', ['get', 'tvm'], '300'],
      ], '#009966',
      ['==', ['get', 'kvb'], 'yes'], '#66cc33',
      ['==', ['get', 'asfa'], 'yes'], '#ff9092',
      ['==', ['get', 'scmt'], 'yes'], '#dd11ff',
      ['==', ['get', 'atc'], 'yes'], '#6600cc',
      ['any',
        ['==', ['get', 'atb'], 'yes'],
        ['==', ['get', 'atb_eg'], 'yes'],
        ['==', ['get', 'atb_ng'], 'yes'],
        ['==', ['get', 'atb_vv'], 'yes'],
      ], '#ff8c00',
      ['==', ['get', 'lzb'], 'yes'], 'red',
      ['==', ['get', 'pzb'], 'yes'], '#ffb900',
      ['==', ['get', 'rank'], '1'], 'black',
      'grey',
    ],
    'line-width': railwayLineWidth,
    'line-dasharray': dashArray,
  });

  const style = {
    center,
    zoom,
    glyphs: "http://localhost:8000/font/{fontstack}/{range}",
    metadata: {},
    name: 'OpenRailwayMap',
    sources: {
      openstreetmap: {
        type: 'raster',
        tiles: [
          'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
        ],
        tileSize: 256,
        attribution: '<a href="https://www.openstreetmap.org/about/" target="_blank">&copy; OpenStreetMap contributors</a>'
      },
      openrailwaymap: {
        type: 'vector',
        url: 'http://localhost:8000/railway_line_casing,railway_line_low,railway_line_med,railway_line_fill,railway_signals,signal_boxes_point,signal_boxes_polygon,signal_boxes_text',
        // url: 'http://localhost:8000/tiles',
      },
      railway_line_casing: {
        type: 'vector',
        url: 'http://localhost:8000/railway_line_casing',
      },
      railway_line_low: {
        type: 'vector',
        url: 'http://localhost:8000/railway_line_low',
      },
      railway_line_med: {
        type: 'vector',
        url: 'http://localhost:8000/railway_line_med',
      },
      railway_line_fill: {
        type: 'vector',
        url: 'http://localhost:8000/railway_line_fill',
      },
      railway_signals: {
        type: 'vector',
        url: 'http://localhost:8000/railway_signals',
      },
      signal_boxes_point: {
        type: 'vector',
        url: 'http://localhost:8000/signal_boxes_point',
      },
      signal_boxes_polygon: {
        type: 'vector',
        url: 'http://localhost:8000/signal_boxes_polygon',
      },
      signal_boxes_text: {
        type: 'vector',
        url: 'http://localhost:8000/signal_boxes_text',
      },
    },
    sprite: [
      {
        id: 'general',
        url: 'http://localhost:8000/sprite/general',
      },
      {
        id: 'nl',
        url: 'http://localhost:8000/sprite/nl',
      },
      {
        id: 'de',
        url: 'http://localhost:8000/sprite/de',
      },
      {
        id: 'flex',
        url: 'http://localhost:8000/sprite/flex',
      },
    ],
    version: 8,
    layers: [
      {
        id: 'background',
        type: 'background',
        paint: {
          'background-color': 'rgb(242, 243, 240)'
        }
      },
      {
        id: "openstreetmap",
        type: "raster",
        source: "openstreetmap",
        paint: {
          'raster-saturation': -1.0, // or 0.0 for colorful
        }
      },

      {
        id: 'railway_line_low_casing_construction',
        type: 'line',
        source: 'openrailwaymap',
        maxzoom: 8,
        'source-layer': 'railway_line_low',
        filter: ['==', ['get', 'railway'], 'construction'],
        paint: casingPaint([2, 2]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_low_casing',
        type: 'line',
        source: 'openrailwaymap',
        maxzoom: 8,
        'source-layer': 'railway_line_low',
        filter: ['!=', ['get', 'railway'], 'construction'],
        paint: casingPaint([1]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_med_casing_construction',
        type: 'line',
        minzoom: 8,
        maxzoom: 9,
        source: 'openrailwaymap',
        'source-layer': 'railway_line_med',
        filter: ['==', ['get', 'railway'], 'construction'],
        paint: casingPaint([2, 2]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_med_casing',
        type: 'line',
        minzoom: 8,
        maxzoom: 9,
        source: 'openrailwaymap',
        'source-layer': 'railway_line_med',
        filter: ['!=', ['get', 'railway'], 'construction'],
        paint: casingPaint([1]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_casing_casing_construction',
        type: 'line',
        source: 'openrailwaymap',
        minzoom: 9,
        'source-layer': 'railway_line_casing',
        filter: ['==', ['get', 'railway'], 'construction'],
        paint: casingPaint([2, 2]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_casing_casing',
        type: 'line',
        source: 'openrailwaymap',
        minzoom: 9,
        'source-layer': 'railway_line_casing',
        filter: ['!=', ['get', 'railway'], 'construction'],
        paint: casingPaint([1]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_low_fill_construction',
        type: 'line',
        source: 'openrailwaymap',
        maxzoom: 8,
        'source-layer': 'railway_line_low',
        filter: ['==', ['get', 'railway'], 'construction'],
        paint: fillPaint([2, 2]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_low_fill',
        type: 'line',
        source: 'openrailwaymap',
        maxzoom: 8,
        'source-layer': 'railway_line_low',
        filter: ['!=', ['get', 'railway'], 'construction'],
        paint: fillPaint([1]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_med_fill_construction',
        type: 'line',
        minzoom: 8,
        maxzoom: 9,
        source: 'openrailwaymap',
        'source-layer': 'railway_line_med',
        filter: ['==', ['get', 'railway'], 'construction'],
        paint: fillPaint([2, 2]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_med_fill',
        type: 'line',
        minzoom: 8,
        maxzoom: 9,
        source: 'openrailwaymap',
        'source-layer': 'railway_line_med',
        filter: ['!=', ['get', 'railway'], 'construction'],
        paint: fillPaint([1]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_fill_construction',
        type: 'line',
        minzoom: 9,
        source: 'openrailwaymap',
        'source-layer': 'railway_line_fill',
        filter: ['==', ['get', 'railway'], 'construction'],
        paint: fillPaint([2, 2]),
        layout: casingLayout,
      },
      {
        id: 'railway_line_fill',
        type: 'line',
        minzoom: 9,
        source: 'openrailwaymap',
        'source-layer': 'railway_line_fill',
        filter: ['!=', ['get', 'railway'], 'construction'],
        paint: fillPaint([1]),
        layout: casingLayout,
      },
      {
        id: 'signal_boxes_point',
        type: 'circle',
        minzoom: 11,
        source: 'openrailwaymap',
        'source-layer': 'signal_boxes_point',
        paint: {
          'circle-color': '#008206',
          'circle-radius': ['step', ['zoom'],
            7,
            15, 12,
            17, 18,
          ],
          'circle-stroke-color': 'white',
          'circle-stroke-width': 1,
        },
      },
      {
        id: 'signal_boxes_polygon',
        type: 'fill',
        minzoom: 13,
        source: 'openrailwaymap',
        'source-layer': 'signal_boxes_polygon',
        paint: {
          'fill-color': '#008206',
          'fill-outline-color': 'white',
        },
      },
      {
        id: 'signal_boxes_polygon_outline',
        type: 'line',
        minzoom: 13,
        source: 'openrailwaymap',
        'source-layer': 'signal_boxes_polygon',
        paint: {
          'line-color': 'white',
          'line-width': 1,
        },
      },
      {
        id: 'railway_signals_base',
        type: 'circle',
        minzoom: 12,
        source: 'openrailwaymap',
        'source-layer': 'railway_signals',
        paint: {
          'circle-radius': 2.2,
        },
      },
      {
        id: 'railway_signals',
        type: 'symbol',
        minzoom: 14,
        source: 'openrailwaymap',
        'source-layer': 'railway_signals',
        paint: {
          // TODO https://github.com/maplibre/martin/issues/1075
          // 'icon-halo-color': 'rgba(255, 255, 255, 1)',
          // 'icon-halo-blur': 0,
          // 'icon-halo-width': 2.0,

          'text-halo-color': 'white',
          'text-halo-width': 1.5,
          'text-halo-blur': 1,
        },
        layout: {
          'icon-overlap': 'always',
          'icon-image': ['case',
            // DE
            // DE crossing distant sign Bü 2
            ['==', ['get', 'feature'], 'DE-ESO:bü2'],
            ['case',
              ['==', ['get', 'crossing_distant_shortened'], 'yes'],
              'de:bue2-ds-reduced-distance',
              'de:bue2-ds',
            ],
            // DE whistle sign Bü 4 (DS 301)
            ['==', ['get', 'feature'], 'DE-ESO:db:bü4'],
            ['case',
              ['==', ['get', 'ring_only_transit'], 'yes'],
              'de:bue4-ds-only-transit',
              'de:bue4-ds',
            ],
            // DE whistle sign Pf 1 (DV 301)
            ['==', ['get', 'feature'], 'DE-ESO:dr:pf1'],
            ['case',
              ['==', ['get', 'ring_only_transit'], 'yes'],
              'de:pf1-dv-only-transit',
              'de:pf1-dv',
            ],
            // DE ring sign Bü 5
            ['==', ['get', 'feature'], 'DE-ESO:bü5'],
            ['case',
              ['==', ['get', 'ring_only_transit'], 'yes'],
              'de:bue5-only-transit',
              'de:bue5',
            ],
            // DE crossing signal Bü 0/1
            ['==', ['get', 'feature'], 'DE-ESO:bü'],
            ['case',
              ['==', ['get', 'crossing_repeated'], 'yes'], 'de:bue1-ds-repeated',
              ['==', ['get', 'crossing_shortened'], 'yes'], 'de:bue1-ds-shortened',
              ['==', ['get', 'crossing_form'], 'sign'],
              ['case',
                ['==', ['get', 'crossing_repeated'], 'yes'], 'de:bue0-ds-repeated',
                ['==', ['get', 'crossing_shortened'], 'yes'], 'de:bue0-ds-shortened',
                'de:bue0-ds'
              ],
              'de:bue1-ds',
            ],
            // DE crossing signal Bü 0/1 (ex. So 16a/b) which can show Bü 1 (ex. So 16b)
            ['all',
              ['==', ['get', 'feature'], 'DE-ESO:so16'],
              ['==', ['get', 'crossing_form'], 'light'],
            ],
            ['case',
              ['==', ['get', 'crossing_repeated'], 'yes'], 'de:bue1-dv-repeated',
              ['==', ['get', 'crossing_shortened'], 'yes'], 'de:bue1-dv-shortened',
              'de:bue1-dv',
            ],
            // DE tram signal "start of train protection" So 1
            ['all',
              ['any',
                ['==', ['get', 'feature'], 'DE-BOStrab:so1'],
                ['==', ['get', 'feature'], 'DE-AVG:so1'],
              ],
              ['==', ['get', 'train_protection_form'], 'sign'],
              ['==', ['get', 'train_protection_type'], 'start'],
            ],
            'de:bostrab/so1',
            // DE tram signal "start of train protection" So 1
            ['all',
              ['any',
                ['==', ['get', 'feature'], 'DE-BOStrab:so2'],
                ['==', ['get', 'feature'], 'DE-AVG:so2'],
              ],
              ['==', ['get', 'train_protection_form'], 'sign'],
              ['==', ['get', 'train_protection_type'], 'end'],
            ],
            'de:bostrab/so2',
            // DE station distant sign Ne 6
            ['all',
              ['==', ['get', 'feature'], 'DE-ESO:ne6'],
              ['==', ['get', 'station_distant_form'], 'sign'],
            ],
            'de:ne6',
            // DE stop demand post Ne 5 (light)
            ['all',
              ['==', ['get', 'feature'], 'DE-ESO:ne5'],
              ['==', ['get', 'stop_demand_form'], 'light'],
              ['==', ['get', 'stop_form'], null],
            ],
            'de:ne5-light',
            // DE stop demand post Ne 5 (sign)
            ['all',
              ['==', ['get', 'feature'], 'DE-ESO:ne5'],
              ['==', ['get', 'stop_demand_form'], null],
              ['==', ['get', 'stop_form'], 'sign'],
            ],
            'de:ne5-sign',
            // DE shunting stop sign Ra 10
            // AT shunting stop sign "Verschubhalttafel"
            ['all',
              ['any',
                ['==', ['get', 'feature'], 'DE-ESO:ra10'],
                ['==', ['get', 'feature'], 'AT-V2:verschubhalttafel'],
              ],
              ['==', ['get', 'shunting_form'], 'sign'],
            ],
            'de:ra10',
            // DE wrong road signal Zs 6(DB) /Zs 7(DR)
            ['all',
              ['==', ['get', 'wrong_road_form'], 'sign'],
              ['==', ['get', 'wrong_road'], 'DE-ESO:db:zs6'],
            ],
            'de:zs6-sign',
            ['all',
              ['==', ['get', 'wrong_road_form'], 'light'],
              ['==', ['get', 'wrong_road'], 'DE-ESO:db:zs6'],
            ],
            'de:zs6-db-light',
            ['all',
              ['==', ['get', 'wrong_road_form'], 'light'],
              ['==', ['get', 'wrong_road'], 'DE-ESO:dr:zs7'],
            ],
            'de:zs7-dr-light',
            // DE tram minor stop sign Sh 1
            ['all',
              ['==', ['get', 'minor_form'], 'sign'],
              ['==', ['get', 'feature'], 'DE-BOStrab:sh1'],
            ],
            'de:bostrab/sh1',
            // DE tram passing prohibited sign So 5
            ['all',
              ['==', ['get', 'passing_form'], 'sign'],
              ['==', ['get', 'passing_type'], 'no_type'],
              ['==', ['get', 'feature'], 'DE-BOStrab:so5'],
            ],
            'de:bostrab/so5',
            // DE tram passing prohibited end sign So 6
            ['all',
              ['==', ['get', 'passing_form'], 'sign'],
              ['==', ['get', 'passing_type'], 'passing_allowed'],
              ['==', ['get', 'feature'], 'DE-BOStrab:so6'],
            ],
            'de:bostrab/so6',
            // DE shunting signal Ra 11 without Sh 1
            // AT Wartesignal ohne "Verschubverbot aufgehoben"
            ['all',
              ['==', ['get', 'shunting_form'], 'sign'],
              ['any',
                ['==', ['get', 'feature'], 'DE-ESO:ra11'],
                ['==', ['get', 'feature'], 'AT-V2:wartesignal'],
              ]
            ],
            'de:ra11-sign',
            // DE shunting signal Ra 11 with Sh 1
            ['all',
              ['==', ['get', 'shunting_form'], 'light'],
              ['==', ['get', 'feature'], 'DE-ESO:ra11'],
            ],
            'de:ra11-sh1',
            // DE shunting signal Ra 11b (without Sh 1)
            ['all',
              ['==', ['get', 'shunting_form'], 'sign'],
              ['==', ['get', 'feature'], 'DE-ESO:ra11b'],
            ],
            'de:ra11b',
            // DE minor light signals type Sh
            ['all',
              ['==', ['get', 'minor_form'], 'light'],
              ['==', ['get', 'feature'], 'DE-ESO:sh'],
            ],
            ['case',
              ['any',
                ['all',
                  ['==', ['get', 'minor_height'], 'normal'],
                  // TODO: minor_states matches "^(.*;)?DE-ESO:sh1(;.*)?$"
                ],
                ['all',
                  ['==', ['get', 'minor_height'], 'normal'],
                  ['==', ['get', 'minor_states'], null],
                ],
                ['all',
                  ['==', ['get', 'minor_height'], null],
                  // TODO minor_states matches ^(.*;)?DE-ESO:sh1(;.*)?$
                ],
                ['all',
                  ['==', ['get', 'minor_height'], null],
                  ['==', ['get', 'minor_states'], null],
                ],
              ],
              'de:sh1-light-normal',
              'de:sh0-light-dwarf',
            ],
            // DE minor semaphore signals and signs type Sh
            ['any',
              ['all',
                ['==', ['get', 'minor_form'], 'semaphore'],
                ['==', ['get', 'feature'], 'DE-ESO:sh'],
              ],
              ['all',
                ['==', ['get', 'minor_form'], 'sign'],
                ['==', ['get', 'feature'], 'DE-ESO:sh0'],
              ],
            ],
            ['case',
              // TODO minor_states matches ^(.*;)?DE-ESO:wn7(;.*)?$
              false,
              'de:wn7-semaphore-normal',
              ['all',
                ['==', ['get', 'minor_form'], 'semaphore'],
                ['any',
                  ['==', ['get', 'minor_height'], 'normal'],
                  ['==', ['get', 'minor_height'], 'null'],
                ],
              ],
              'de:sh1-semaphore-normal',
              'de:sh0-semaphore-dwarf',
            ],
            // DE signal Sh 2 as signal and at buffer stops
            ['any',
              ['==', ['get', 'feature'], 'DE-ESO:sh2'],
              ['==', ['get', 'feature'], 'DE-BOStrab:sh2'],
            ],
            'de:sh2',
            // DE Signalhaltmelder Zugleitbetrieb
            // repeats DE-ESO:hp0 of the entrance main signal to the halt position
            ['all',
              ['==', ['get', 'feature'], 'feature'],
              ['==', ['get', 'main_repeated_form'], 'light'],
            ],
            'de:zlb-haltmelder-light',
            // DE main entry sign Ne 1
            ['all',
              ['==', ['get', 'main_form'], 'sign'],
              ['any',
                ['==', ['get', 'feature'], 'DE-ESO:ne1'],
                ['==', ['get', 'feature'], 'AT-V2:trapeztafel'],
              ],
            ],
            'de:ne1',
            // DE distant light signals type Vr which
            //  - are repeaters or shortened
            //  - have no railway:signal:states=* tag
            //  - OR have railway:signal:states=* tag that does neither include Vr1 nor Vr2
            ['all',
              ['==', ['get', 'distant_form'], 'light'],
              ['==', ['get', 'feature'], 'DE-ESO:vr'],
            ],
            ['case',
              // TODO distant_states matches ^(.*;)?DE-ESO:vr1(;.*)?$
              false,
              'de:vr1-light',
              // TODO distant_states matches ^(.*;)?DE-ESO:vr2(;.*)?$
              false,
              'de:vr2-light',
              ['any',
                ['==', ['get', 'distant_repeated'], 'yes'],
                ['==', ['get', 'distant_shortened'], 'yes'],
              ],
              ['case',
                // TODO distant_states matches ^(.*;)?DE-ESO:vr1(;.*)?$
                false,
                'de:vr1-light-repeated',
                // TODO distant_states matches ^(.*;)?DE-ESO:vr2(;.*)?$
                false,
                'de:vr2-light-repeated',
                'de:vr0-light-repeated'
              ],
              'de:vr0-light',
            ],
            // DE distant semaphore signals type Vr which
            //  - have no railway:signal:states=* tag
            //  - OR have railway:signal:states=* tag that does neither include Vr1 nor Vr2
            ['all',
              ['==', ['get', 'distant_form'], 'semaphore'],
              ['==', ['get', 'feature'], 'DE-ESO:vr'],
            ],
            ['case',
              // TODO distant_states matches ^(.*;)?DE-ESO:vr1(;.*)?$
              false,
              'de:vr1-semaphore',
              // TODO distant_states matches ^(.*;)?DE-ESO:vr2(;.*)?$
              false,
              'de:vr2-semaphore',
              'de:vr0-semaphore',
            ],
            // DE Hamburger Hochbahn distant signal
            ['all',
              ['==', ['get', 'distant_form'], 'light'],
              ['==', ['get', 'feature'], 'DE-HHA:v'],
            ],
            'de:hha/v1',
            // DE block marker ("Blockkennzeichen")
            ['==', ['get', 'feature'], 'DE-ESO:blockkennzeichen'],
            // TODO adopt flex/de/blockkennzeichen-[width]x[height]
            'de:blockkennzeichen',
            // DE distant signal replacement by sign So 106
            // AT Kreuztafel
            ['all',
              ['==', ['get', 'distant_form'], 'sign'],
              ['any',
                ['==', ['get', 'feature'], 'DE-ESO:so106'],
                ['==', ['get', 'feature'], 'AT-V2:kreuztafel'],
              ],
            ],
            'de:so106',
            // DE distant signal replacement by sign Ne 2
            ['all',
              ['==', ['get', 'distant_form'], 'sign'],
              ['==', ['get', 'feature'], 'DE-ESO:db:ne2'],
            ],
            ['case',
              ['==', ['get', 'distant_shortened'], 'yes'],
              'de:ne2-reduced-distance',
              'de:ne2',
            ],
            // DE main semaphore signals type Hp
            ['all',
              ['==', ['get', 'main_form'], 'semaphore'],
              ['==', ['get', 'feature'], 'DE-ESO:hp'],
            ],
            ['case',
              // TODO main_states matches ^(.*;)?DE-ESO:hp1(;.*)?$
              false,
              'de:hp1-semaphore',
              // TODO main_states matches ^(.*;)?DE-ESO:hp2(;.*)?$
              false,
              'de:hp2-semaphore',
              'de:hp0-semaphore',
            ],
            // AT main semaphore signal "Hauptsignal"
            ['all',
              ['==', ['get', 'main_form'], 'semaphore'],
              ['==', ['get', 'feature'], 'AT-V2:hauptsignal'],
            ],
            ['case',
              // TODO main_states matches ^(.*;)?AT-V2:frei(;.*)?$
              false,
              'de:hp1-semaphore',
              // TODO main_states matches ^(.*;)?AT-V2:frei_mit_40(;.*)?$
              // TODO main_states matches ^(.*;)?AT-V2:frei_mit_20(;.*)?$
              false,
              'de:hp2-semaphore',
              'de:hp0-semaphore',
            ],
            // DE main light signals type Hp
            ['all',
              ['==', ['get', 'main_form'], 'light'],
              ['==', ['get', 'feature'], 'DE-ESO:hp'],
            ],
            ['case',
              // TODO main_states matches ^(.*;)?DE-ESO:hp1(;.*)?$
              false,
              'de:hp1-light',
              // TODO main_states matches ^(.*;)?DE-ESO:hp2(;.*)?$
              false,
              'de:hp2-light',
              'de:hp0-light',
            ],
            // DE main, combined and distant light signals type Hl
            ['==', ['get', 'feature'], 'DE-ESO:hl'],
            ['case',
              ['all',
                ['==', ['get', 'main_form'], null],
                ['==', ['get', 'distant_form'], 'light'],
                ['==', ['get', 'combined_form'], null],
              ],
              'de:hl1-distant',
              ['all',
                ['==', ['get', 'main_form'], 'light'],
                ['==', ['get', 'distant_form'], null],
                ['==', ['get', 'combined_form'], null],
              ],
              ['case',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl1(;.*)?$
                false, 'de:hl1',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl3a(;.*)?$
                false, 'de:hl3a',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl3b(;.*)?$
                false, 'de:hl3b',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl2(;.*)?$
                false, 'de:hl2',
                'de:hl0'
              ],
              ['all',
                ['==', ['get', 'main_form'], null],
                ['==', ['get', 'distant_form'], null],
                ['==', ['get', 'combined_form'], 'light'],
              ],
              ['case',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl10(;.*)?$
                false, 'de:hl10',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl12a(;.*)?$
                false, 'de:hl12a',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl12b(;.*)?$
                false, 'de:hl12b',
                // TODO combined_states matches ^(.*;)?DE-ESO:hl11(;.*)?$
                false, 'de:hl11',
                'de:hl0'
              ],
              ''
            ],
            // DE combined light signals type Sv
            ['==', ['get', 'feature'], 'DE-ESO:sv'],
            ['case',
              // TODO combined_states matches ^(.*;)?DE-ESO:sv0(;.*)?$
              false, 'de:sv0',
              // TODO combined_states matches ^(.*;)?DE-ESO:hp0(;.*)?$
              false, 'de:hp0',
              'de:sv0', // TODO remove this unknown value
            ],
            // DE tram main signal "Fahrsignal"
            ['all',
              ['==', ['get', 'main_form'], 'light'],
              ['any',
                ['==', ['get', 'feature'], 'DE-BOStrab:f'],
                ['==', ['get', 'feature'], 'DE-AVG:f'],
              ],
            ],
            ['case',
              // TODO main_states matches ^(.*;)?DE-BOStrab:f1(;.*)?$
              false, 'de:bostrab/f1',
              // TODO main_states matches ^(.*;)?DE-BOStrab:f2(;.*)?$
              false, 'de:bostrab/f2',
              // TODO main_states matches ^(.*;)?DE-BOStrab:f3(;.*)?$
              false, 'de:bostrab/f3',
              'de:bostrab/f0',
            ],
            // DE Hamburger Hochbahn main signal
            ['all',
              ['==', ['get', 'main_form'], 'light'],
              ['==', ['get', 'feature'], 'DE-HHA:h'],
            ],
            ['case',
              ['==', ['get', 'main_states'], null],
              'de:hha/h1',
              'de:hha/h0',
            ],
            // DE main, combined and distant signals type Ks
            ['==', ['get', 'feature'], 'DE-ESO:ks'],
            ['case',
              ['all',
                ['==', ['get', 'main_form'], null],
                ['==', ['get', 'distant_form'], 'light'],
                ['==', ['get', 'combined_form'], null],
              ],
              ['case',
                ['==', ['get', 'distant_repeated'], 'yes'], 'de:ks-distant-repeated',
                ['==', ['get', 'distant_shortened'], 'yes'], 'de:ks-distant-shortened',
                'de:ks-distant',
              ],
              ['all',
                ['==', ['get', 'main_form'], 'light'],
                ['==', ['get', 'distant_form'], null],
                ['==', ['get', 'combined_form'], null],
              ],
              'de:ks-main',
              ['all',
                ['==', ['get', 'main_form'], null],
                ['==', ['get', 'distant_form'], null],
                ['==', ['get', 'combined_form'], 'light'],
              ],
              ['case',
                ['==', ['get', 'combined_shortened'], 'yes'],
                'de:ks-combined-shortened',
                'de:ks-combined',
              ],
              ''
            ],
            // NL
            ['all',
              ['==', ['get', 'departure_form'], 'light'],
              ['any',
                ['==', ['get', 'feature'], 'NL'],
                ['==', ['get', 'feature'], 'NL:VL'],
              ]
            ], 'nl:departure',
            ['==', ['get', 'feature'], 'NL'],
            ['case',
              ['all',
                ['==', ['get', 'main_height'], 'dwarf'],
                ['==', ['get', 'shunting_form'], 'light'],
              ], 'nl:main_light_dwarf_shunting',
              ['all',
                ['==', ['get', 'train_protection_type'], 'block_marker'],
                ['==', ['get', 'train_protection_form'], 'light'],
              ], 'nl:main_light_white_bar',
              ['==', ['get', 'main_height'], 'dwarf'], 'nl:main_light_dwarf',
              ['==', ['get', 'shunting_form'], 'light'], 'nl:main_light_shunting',
              ['==', ['get', 'distant_form'], 'light'], 'nl:distant_light',
              // TODO ['==', ['get', 'main_repeated_form'], 'light'], 'nl:main_repeated_light',
              ['==', ['get', 'main_repeated_states'], 'NL:272;NL:273'], 'nl:main_repeated_light',
              ['all',
                ['==', ['get', 'speed_limit_form'], 'light'],
                ['==', ['get', 'speed_limit_states'], 'H;off'],
              ], 'nl:H',
              ['all',
                ['==', ['get', 'speed_limit_form'], 'light'],
                ['==', ['get', 'speed_limit_states'], 'L;off'],
              ], 'nl:L',
              ['all',
                ['==', ['get', 'main_form'], 'light'],
                ['==', ['get', 'speed_limit_form'], 'light'],
              ], 'nl:main_light_speed_limit',
              ['all',
                ['==', ['get', 'distant_form'], 'light'],
                ['==', ['get', 'speed_limit_form'], 'light'],
              ], 'nl:distant_light_speed_limit',
              ['==', ['get', 'main_form'], 'light'], 'nl:main_light',
              ['==', ['get', 'speed_limit_form'], 'light'], 'nl:speed_limit_light',
              '',
            ],
            ['==', ['get', 'feature'], 'NL:270'], 'nl:270a',
            ['==', ['get', 'feature'], 'NL:330'], 'nl:atb-codewissel',
            ['all',
              ['any',
                ['==', ['get', 'feature'], 'DE-ESO:ne14'],
                ['==', ['get', 'feature'], 'NL:227b'],
              ],
              ['==', ['get', 'train_protection_form'], 'sign'],
              ['==', ['get', 'train_protection_type'], 'block_marker'],
            ],
            ['case',
              ['all',
                ['==', ['get', 'feature'], 'NL:227b'],
                ['==', ['get', 'train_protection_shape'], 'triangle'],
              ], 'general:etcs-stop-marker-arrow-left',
              'general:etcs-stop-marker-triangle-left'
            ],
            '',
          ],
          'text-field': '{ref}',
          'text-font': ['Noto Sans Medium'],
          'text-size': 9,
          'text-anchor': 'top',
          'text-offset': ['case',
            ['==', ['get', 'main_height'], 'dwarf'], ['literal', [0, 1]],
            ['any',
              ['all',
                ['==', ['get', 'main_form'], 'light'],
                ['==', ['get', 'speed_limit_form'], 'light'],
              ],
              ['all',
                ['==', ['get', 'distant_form'], 'light'],
                ['==', ['get', 'speed_limit_form'], 'light'],
              ],
            ], ['literal', [0, 2]],
            ['literal', [0, 1.5]],
          ],
        }
      },
      {
        id: 'railway_signals_deactivated',
        type: 'symbol',
        minzoom: 14,
        source: 'openrailwaymap',
        'source-layer': 'railway_signals',
        filter: ['==', ['get', 'deactivated'], 'yes'],
        layout: {
          'icon-overlap': 'always',
          'icon-image': 'general:signal-deactivated',
        }
      },
      {
        id: 'signal_boxes_text_medium',
        type: 'symbol',
        minzoom: 13,
        maxzoom: 16,
        source: 'openrailwaymap',
        'source-layer': 'signal_boxes_text',
        paint: {
          'text-color': '#404040',
          'text-halo-color': '#bfffb3',
          'text-halo-width': 1.5,
        },
        layout: {
          'text-field': '{ref}',
          'text-font': ['Noto Sans Bold'],
          'text-size': 11,
        }
      },
      {
        id: 'signal_boxes_text_high',
        type: 'symbol',
        minzoom: 16,
        source: 'openrailwaymap',
        'source-layer': 'signal_boxes_text',
        paint: {
          'text-color': '#404040',
          'text-halo-color': '#bfffb3',
          'text-halo-width': 1.5,
        },
        layout: {
          'text-field': '{name}',
          'text-font': ['Noto Sans Bold'],
          'text-size': 11,
        }
      },
    ],
  };

  const map = new maplibregl.Map({
    container: 'map',
    style,
  });

  const onMoveZoom = () => {
    localStorage.setItem('zoom', map.getZoom());
    localStorage.setItem('center', JSON.stringify([map.getCenter().lng, map.getCenter().lat]));
  };
  // const onMissingImage = (q) => {
  //   console.info(q);
  //   return map.getImage('general:unknown');
  // }
  map.on('load', () => {
    map.on('moveend', onMoveZoom)
    map.on('zoomend', onMoveZoom)
    // map.on('styleimagemissing', onMissingImage)
  });
</script>
</body>

</html>
